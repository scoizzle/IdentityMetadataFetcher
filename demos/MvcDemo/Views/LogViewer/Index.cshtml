@using System.Collections.Generic
@using MvcDemo.Utilities

@model List<TraceLogEntry>

@{
    ViewBag.Title = "Trace Log Viewer";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="logs-hero bg-gradient-info text-white py-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="h2 fw-bold mb-2">
                    <i class="fas fa-list-alt me-2"></i>
                    Trace Log Viewer
                </h1>
                <p class="mb-0 opacity-75">
                    Monitor real-time application activity, metadata polling events, and system diagnostics.
                </p>
            </div>
            <div class="col-lg-4 text-center">
                <div class="hero-icon">
                    <i class="fas fa-stream fa-4x text-white opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container my-4">
    <div class="row justify-content-center">
        <div class="col-xl-12">
            <!-- Controls Card -->
            <div class="card shadow-lg border-0 rounded-3 overflow-hidden mb-4">
                <div class="card-header bg-white border-bottom-0 py-4">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <div>
                            <h4 class="mb-1">Log Controls</h4>
                            <p class="text-muted mb-0">Manage log viewing and real-time updates</p>
                        </div>
                        <div class="d-flex gap-2">
                            @Html.ActionLink("Clear Logs", "Clear", "LogViewer", null, new { @class = "btn btn-outline-danger btn-lg px-4" })
                            <button type="button" class="btn btn-primary btn-lg px-4" onclick="location.reload();">
                                <i class="fas fa-sync-alt me-2"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card-body p-4">
                    <!-- Statistics -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card p-3 bg-light rounded-3 text-center">
                                <div class="stat-number h3 text-primary mb-1" id="logCount">@Model.Count</div>
                                <div class="stat-label text-muted">Total Entries</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card p-3 bg-light rounded-3 text-center">
                                <div class="stat-number h3 text-info mb-1">@TraceLogBuffer.Instance.MaxCapacity</div>
                                <div class="stat-label text-muted">Buffer Capacity</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card p-3 bg-light rounded-3 text-center">
                                <div class="stat-number h3 text-success mb-1" id="displayCount">@Model.Count</div>
                                <div class="stat-label text-muted">Displayed</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card p-3 bg-light rounded-3 text-center">
                                <div class="stat-number h3 text-warning mb-1">500</div>
                                <div class="stat-label text-muted">Max Display</div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings -->
                    <div class="settings-section p-3 bg-light rounded-3">
                        <h6 class="mb-3">
                            <i class="fas fa-cog text-primary me-2"></i>
                            Display Settings
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                                    <label class="form-check-label" for="autoRefresh">
                                        <strong>Auto-refresh</strong> (every 0.5 seconds)
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="autoScroll" checked>
                                    <label class="form-check-label" for="autoScroll">
                                        <strong>Auto-scroll</strong> to bottom
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs Display -->
            <div class="card shadow-lg border-0 rounded-3 overflow-hidden">
                <div class="card-header bg-white border-bottom-0 py-4">
                    <div class="d-flex align-items-center">
                        <div class="bg-info rounded-circle p-3 me-3">
                            <i class="fas fa-terminal fa-lg text-white"></i>
                        </div>
                        <div>
                            <h4 class="mb-1">Live Log Stream</h4>
                            <p class="text-muted mb-0">Real-time application logs and system events</p>
                        </div>
                    </div>
                </div>

                <div class="card-body p-0">
                    <!-- No Logs Alert -->
                    <div id="noLogsAlert" class="alert alert-info border-0 rounded-0 m-0" style="display: @(Model.Count == 0 ? "block" : "none");">
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-info mb-3"></i>
                            <h5>No trace logs available</h5>
                            <p class="mb-0">Logs will appear here as they are generated by the application.</p>
                        </div>
                    </div>

                    <!-- Logs Table -->
                    <div id="logsTableContainer" class="logs-container" style="display: @(Model.Count > 0 ? "block" : "none");">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="logsTable">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th class="border-0 fw-semibold" style="width: 200px;">
                                            <i class="fas fa-clock me-2 text-muted"></i>Timestamp
                                        </th>
                                        <th class="border-0 fw-semibold" style="width: 120px;">
                                            <i class="fas fa-tag me-2 text-muted"></i>Level
                                        </th>
                                        <th class="border-0 fw-semibold">
                                            <i class="fas fa-comment me-2 text-muted"></i>Message
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="logsBody" class="small">
                                    @foreach (var entry in Model)
                                    {
                                        <tr class="log-entry">
                                            <td class="text-muted">
                                                <code class="bg-light px-2 py-1 rounded">@entry.FormattedTimestamp</code>
                                            </td>
                                            <td>
                                                @{
                                                    var badgeClass = "bg-secondary";
                                                    var iconClass = "fas fa-info-circle";
                                                    switch (entry.Level)
                                                    {
                                                        case "Information":
                                                            badgeClass = "bg-info";
                                                            iconClass = "fas fa-info-circle";
                                                            break;
                                                        case "Warning":
                                                            badgeClass = "bg-warning text-dark";
                                                            iconClass = "fas fa-exclamation-triangle";
                                                            break;
                                                        case "Error":
                                                            badgeClass = "bg-danger";
                                                            iconClass = "fas fa-times-circle";
                                                            break;
                                                        case "Verbose":
                                                            badgeClass = "bg-light text-dark";
                                                            iconClass = "fas fa-bug";
                                                            break;
                                                    }
                                                }
                                                <span class="badge @badgeClass fs-7 px-2 py-1">
                                                    <i class="@iconClass me-1"></i>@entry.Level
                                                </span>
                                            </td>
                                            <td>
                                                <div class="log-message">
                                                    @Html.Raw(System.Web.HttpUtility.HtmlEncode(entry.Message))
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-gradient-info {
        background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
    }

    .hero-icon {
        animation: pulse 2s ease-in-out infinite;
    }

    @@keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .stat-card {
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .stat-number {
        font-weight: 700;
    }

    .settings-section {
        border: 1px solid rgba(0,0,0,0.05);
    }

    .logs-container {
        max-height: 600px;
        overflow-y: auto;
    }

    .log-entry {
        transition: background-color 0.2s ease;
    }

    .log-entry:hover {
        background-color: rgba(0,123,255,0.02) !important;
    }

    .log-message {
        word-wrap: break-word;
        max-width: 100%;
    }

    .card {
        transition: all 0.3s ease;
    }

    .card:hover {
        box-shadow: 0 20px 40px rgba(0,0,0,0.1) !important;
    }

    .badge {
        font-size: 0.75rem !important;
    }

    .fs-7 {
        font-size: 0.8rem !important;
    }
</style>

@section Scripts {
    <script type="text/javascript">
        $(function () {
            var lastLogTimestamp = null;
            var autoRefreshEnabled = true;
            var autoScrollEnabled = true;
            var maxDisplayedLogs = 500;
            var hasLogs = @(Model.Count > 0 ? "true" : "false");
            var lastPollStorageKey = 'logViewer_lastPollDateTime';

            // Initialize with the timestamp from sessionStorage, or from the last log if available
            var storedLastPoll = sessionStorage.getItem(lastPollStorageKey);
            if (storedLastPoll) {
                lastLogTimestamp = storedLastPoll;
            } else {
                var rows = $('#logsBody tr');
                if (rows.length > 0) {
                    var lastRow = rows.last();
                    var timestampCell = lastRow.find('td:first code');
                    if (timestampCell.length > 0) {
                        // Extract the raw timestamp from the data attribute or parse from formatted text
                        // For initial page load, we need to use a parseable format
                        lastLogTimestamp = timestampCell.text();
                        // Persist this to sessionStorage for future refreshes
                        if (lastLogTimestamp) {
                            sessionStorage.setItem(lastPollStorageKey, lastLogTimestamp);
                        }
                    }
                }
            }

            // Toggle auto-refresh
            $('#autoRefresh').change(function() {
                autoRefreshEnabled = $(this).is(':checked');
                if (autoRefreshEnabled) {
                    refreshLogs();
                }
            });

            // Toggle auto-scroll
            $('#autoScroll').change(function() {
                autoScrollEnabled = $(this).is(':checked');
            });

            function formatLogRow(entry) {
                var badgeClass = 'bg-secondary';
                var iconClass = 'fas fa-info-circle';
                var level = entry.level;

                if (level === 'Information') {
                    badgeClass = 'bg-info';
                    iconClass = 'fas fa-info-circle';
                } else if (level === 'Warning') {
                    badgeClass = 'bg-warning text-dark';
                    iconClass = 'fas fa-exclamation-triangle';
                } else if (level === 'Error') {
                    badgeClass = 'bg-danger';
                    iconClass = 'fas fa-times-circle';
                } else if (level === 'Verbose') {
                    badgeClass = 'bg-light text-dark';
                    iconClass = 'fas fa-bug';
                }

                var row = '<tr class="log-entry">' +
                    '<td class="text-muted"><code>' + escapeHtml(entry.formattedTimestamp) + '</code></td>' +
                    '<td><span class="badge ' + badgeClass + ' fs-7 px-2 py-1"><i class="' + iconClass + ' me-1"></i>' + escapeHtml(level) + '</span></td>' +
                    '<td><div class="log-message">' + escapeHtml(entry.message) + '</div></td>' +
                    '</tr>';

                return row;
            }

            function escapeHtml(text) {
                var div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function isScrolledToBottom() {
                var container = $('#logsTableContainer');
                return container.scrollTop() + container.innerHeight() >= container[0].scrollHeight - 1;
            }

            function scrollToBottom() {
                var container = $('#logsTableContainer');
                container.scrollTop(container[0].scrollHeight);
            }

            function updateDisplayCounts() {
                var totalRows = $('#logsBody tr').length;
                $('#displayCount').text(totalRows);
                
                // Note: logCount represents the total in the server's buffer
                // It's set on page load and only updates on full refresh or Clear
                
                // Show/hide the appropriate UI elements
                if (totalRows === 0 && !hasLogs) {
                    $('#noLogsAlert').show();
                    $('#logsTableContainer').hide();
                } else {
                    $('#noLogsAlert').hide();
                    $('#logsTableContainer').show();
                }
            }

            function refreshLogs() {
                // Build the AJAX URL with the 'since' parameter if we have a last timestamp
                var url = '@Url.Action("GetLogs", "LogViewer")';
                if (lastLogTimestamp) {
                    url += '?since=' + encodeURIComponent(lastLogTimestamp);
                }

                $.ajax({
                    url: url,
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        if (response && response.logs && response.logs.length > 0) {
                            var newLogs = response.logs;
                            var wasAtBottom = isScrolledToBottom();

                            // Hide the "no logs available" alert if logs are coming in
                            if ($('#noLogsAlert').is(':visible')) {
                                $('#noLogsAlert').hide();
                                $('#logsTableContainer').show();
                            }

                            // Append new logs
                            $.each(newLogs, function(index, log) {
                                var $row = $(formatLogRow(log));
                                $('#logsBody').append($row);
                            });

                            // Update the last timestamp to current time (after successful fetch)
                            // This ensures we never miss logs that arrive between requests
                            lastLogTimestamp = new Date().toISOString();

                            // Persist the last poll timestamp to sessionStorage
                            if (lastLogTimestamp) {
                                sessionStorage.setItem(lastPollStorageKey, lastLogTimestamp);
                            }

                            // Enforce the 500-row limit by removing oldest rows
                            var rows = $('#logsBody tr');
                            if (rows.length > maxDisplayedLogs) {
                                var excessRows = rows.length - maxDisplayedLogs;
                                rows.slice(0, excessRows).remove();
                            }

                            // Auto-scroll to bottom if enabled and user was at bottom
                            if (autoScrollEnabled && wasAtBottom) {
                                scrollToBottom();
                            }

                            updateDisplayCounts();
                        }
                    },
                    error: function() {
                        console.log('Error refreshing logs');
                    }
                });
            }

            // Override the Clear button behavior
            $('.btn-warning').on('click', function(e) {
                // Clear the stored last poll timestamp
                sessionStorage.removeItem(lastPollStorageKey);
                lastLogTimestamp = null;
                // Allow the normal link action to proceed (redirect to Clear action)
            });

            // Set up auto-refresh interval
            if (autoRefreshEnabled) {
                setInterval(function() {
                    if (autoRefreshEnabled) {
                        refreshLogs();
                    }
                }, 500); // Refresh every 0.5 seconds
            }

            // Update display count on initial load
            updateDisplayCounts();

            // Initial scroll to bottom if there are logs
            var rows = $('#logsBody tr');
            if (rows.length > 0) {
                scrollToBottom();
            }
        });
    </script>
}
