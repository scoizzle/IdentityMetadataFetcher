@using System.Collections.Generic
@using MvcDemo.Utilities

@model List<TraceLogEntry>

@{
    ViewBag.Title = "Trace Log Viewer";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Trace Log Viewer</h2>

<div class="log-viewer-container" style="margin: 20px 0;">
    <div style="margin-bottom: 15px;">
        <p><strong>Total Entries in Buffer:</strong> <span id="logCount">@Model.Count</span> / @TraceLogBuffer.Instance.MaxCapacity | <strong>Displayed on Page:</strong> <span id="displayCount">@Model.Count</span> / 500</p>
        @Html.ActionLink("Clear Logs", "Clear", "LogViewer", null, new { @class = "btn btn-warning" })
        <button type="button" class="btn btn-primary" onclick="location.reload();">Refresh</button>
        <label style="margin-left: 20px;">
            <input type="checkbox" id="autoRefresh" checked="checked" /> 
            <span>Auto-refresh (every 0.5 seconds)</span>
        </label>
        <label style="margin-left: 20px;">
            <input type="checkbox" id="autoScroll" checked="checked" /> 
            <span>Auto-scroll to bottom</span>
        </label>
    </div>

    <div id="noLogsAlert" class="alert alert-info" style="display: @(Model.Count == 0 ? "block" : "none");">
        No trace logs available. Logs will appear here as they are generated by the application.
    </div>
    
    <div id="logsTableContainer" class="logs-table-container" style="display: @(Model.Count > 0 ? "block" : "none");">
        <table class="table table-striped table-sm" style="font-size: 12px;" id="logsTable">
            <thead>
                <tr>
                    <th style="width: 180px;">Timestamp</th>
                    <th style="width: 80px;">Level</th>
                    <th>Message</th>
                </tr>
            </thead>
            <tbody id="logsBody">
                @foreach (var entry in Model)
                {
                    <tr>
                        <td><code>@entry.FormattedTimestamp</code></td>
                        <td>
                            @{
                                var badgeClass = "badge badge-secondary";
                                switch (entry.Level)
                                {
                                    case "Information":
                                        badgeClass = "badge badge-info";
                                        break;
                                    case "Warning":
                                        badgeClass = "badge badge-warning";
                                        break;
                                    case "Error":
                                        badgeClass = "badge badge-danger";
                                        break;
                                    case "Verbose":
                                        badgeClass = "badge badge-light";
                                        break;
                                }
                            }
                            <span class="@badgeClass">@entry.Level</span>
                        </td>
                        <td><code>@Html.Raw(System.Web.HttpUtility.HtmlEncode(entry.Message))</code></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<style>
    .log-viewer-container {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
    }

    .logs-table-container {
        height: 500px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background-color: #ffffff;
    }

    .logs-table-container table {
        margin-bottom: 0;
    }

    .logs-table-container thead {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 10;
    }

    .log-viewer-container table code {
        background-color: #f4f4f4;
        padding: 2px 4px;
        border-radius: 2px;
    }

    .btn {
        padding: 6px 12px;
        margin-right: 5px;
        text-decoration: none;
        border-radius: 4px;
        display: inline-block;
        cursor: pointer;
        font-size: 14px;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
        border: 1px solid #007bff;
    }

    .btn-primary:hover {
        background-color: #0056b3;
    }

    .btn-warning {
        background-color: #ffc107;
        color: black;
        border: 1px solid #ffc107;
    }

    .btn-warning:hover {
        background-color: #e0a800;
    }
</style>

@section Scripts {
    <script type="text/javascript">
        $(function () {
            var lastLogTimestamp = null;
            var autoRefreshEnabled = true;
            var autoScrollEnabled = true;
            var maxDisplayedLogs = 500;
            var hasLogs = @(Model.Count > 0 ? "true" : "false");
            var lastPollStorageKey = 'logViewer_lastPollDateTime';

            // Initialize with the timestamp from sessionStorage, or from the last log if available
            var storedLastPoll = sessionStorage.getItem(lastPollStorageKey);
            if (storedLastPoll) {
                lastLogTimestamp = storedLastPoll;
            } else {
                var rows = $('#logsBody tr');
                if (rows.length > 0) {
                    var lastRow = rows.last();
                    var timestampCell = lastRow.find('td:first code');
                    if (timestampCell.length > 0) {
                        // Extract the raw timestamp from the data attribute or parse from formatted text
                        // For initial page load, we need to use a parseable format
                        lastLogTimestamp = timestampCell.text();
                        // Persist this to sessionStorage for future refreshes
                        if (lastLogTimestamp) {
                            sessionStorage.setItem(lastPollStorageKey, lastLogTimestamp);
                        }
                    }
                }
            }

            // Toggle auto-refresh
            $('#autoRefresh').change(function() {
                autoRefreshEnabled = $(this).is(':checked');
                if (autoRefreshEnabled) {
                    refreshLogs();
                }
            });

            // Toggle auto-scroll
            $('#autoScroll').change(function() {
                autoScrollEnabled = $(this).is(':checked');
            });

            function formatLogRow(entry) {
                var badgeClass = 'badge badge-secondary';
                var level = entry.level;

                if (level === 'Information') {
                    badgeClass = 'badge badge-info';
                } else if (level === 'Warning') {
                    badgeClass = 'badge badge-warning';
                } else if (level === 'Error') {
                    badgeClass = 'badge badge-danger';
                } else if (level === 'Verbose') {
                    badgeClass = 'badge badge-light';
                }

                var row = '<tr>' +
                    '<td><code>' + escapeHtml(entry.formattedTimestamp) + '</code></td>' +
                    '<td><span class="' + badgeClass + '">' + escapeHtml(level) + '</span></td>' +
                    '<td><code>' + escapeHtml(entry.message) + '</code></td>' +
                    '</tr>';

                return row;
            }

            function escapeHtml(text) {
                var div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function isScrolledToBottom() {
                var container = $('#logsTableContainer');
                return container.scrollTop() + container.innerHeight() >= container[0].scrollHeight - 1;
            }

            function scrollToBottom() {
                var container = $('#logsTableContainer');
                container.scrollTop(container[0].scrollHeight);
            }

            function updateDisplayCounts() {
                var totalRows = $('#logsBody tr').length;
                $('#displayCount').text(totalRows);
                
                // Note: logCount represents the total in the server's buffer
                // It's set on page load and only updates on full refresh or Clear
                
                // Show/hide the appropriate UI elements
                if (totalRows === 0 && !hasLogs) {
                    $('#noLogsAlert').show();
                    $('#logsTableContainer').hide();
                } else {
                    $('#noLogsAlert').hide();
                    $('#logsTableContainer').show();
                }
            }

            function refreshLogs() {
                // Build the AJAX URL with the 'since' parameter if we have a last timestamp
                var url = '@Url.Action("GetLogs", "LogViewer")';
                if (lastLogTimestamp) {
                    url += '?since=' + encodeURIComponent(lastLogTimestamp);
                }

                $.ajax({
                    url: url,
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        if (response && response.logs && response.logs.length > 0) {
                            var newLogs = response.logs;
                            var wasAtBottom = isScrolledToBottom();

                            // Hide the "no logs available" alert if logs are coming in
                            if ($('#noLogsAlert').is(':visible')) {
                                $('#noLogsAlert').hide();
                                $('#logsTableContainer').show();
                            }

                            // Append new logs
                            $.each(newLogs, function(index, log) {
                                var $row = $(formatLogRow(log));
                                $('#logsBody').append($row);
                            });

                            // Update the last timestamp to current time (after successful fetch)
                            // This ensures we never miss logs that arrive between requests
                            lastLogTimestamp = new Date().toISOString();

                            // Persist the last poll timestamp to sessionStorage
                            if (lastLogTimestamp) {
                                sessionStorage.setItem(lastPollStorageKey, lastLogTimestamp);
                            }

                            // Enforce the 500-row limit by removing oldest rows
                            var rows = $('#logsBody tr');
                            if (rows.length > maxDisplayedLogs) {
                                var excessRows = rows.length - maxDisplayedLogs;
                                rows.slice(0, excessRows).remove();
                            }

                            // Auto-scroll to bottom if enabled and user was at bottom
                            if (autoScrollEnabled && wasAtBottom) {
                                scrollToBottom();
                            }

                            updateDisplayCounts();
                        }
                    },
                    error: function() {
                        console.log('Error refreshing logs');
                    }
                });
            }

            // Override the Clear button behavior
            $('.btn-warning').on('click', function(e) {
                // Clear the stored last poll timestamp
                sessionStorage.removeItem(lastPollStorageKey);
                lastLogTimestamp = null;
                // Allow the normal link action to proceed (redirect to Clear action)
            });

            // Set up auto-refresh interval
            if (autoRefreshEnabled) {
                setInterval(function() {
                    if (autoRefreshEnabled) {
                        refreshLogs();
                    }
                }, 500); // Refresh every 0.5 seconds
            }

            // Update display count on initial load
            updateDisplayCounts();

            // Initial scroll to bottom if there are logs
            var rows = $('#logsBody tr');
            if (rows.length > 0) {
                scrollToBottom();
            }
        });
    </script>
}
